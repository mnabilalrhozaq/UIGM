FIX PASSWORD VERIFICATION - SUPPORT PLAIN TEXT & HASHED
========================================================
Tanggal: 23 Januari 2026

MASALAH:
========
Saat user/TPS ingin ubah password, selalu muncul error:
"Password lama tidak sesuai"

Padahal password yang diinput sudah benar.

PENYEBAB:
=========
Password di database masih dalam format PLAIN TEXT (tidak di-hash):
- pengelolatps: tps123 (plain text)
- habibtino: habib12345 (plain text)
- Agiz: tps12345 (plain text)

Sementara kode menggunakan password_verify() yang hanya bisa verify
password yang sudah di-hash dengan password_hash().

SOLUSI:
=======
Modifikasi method changePassword() untuk support KEDUA format:
1. Plain text (password lama di database)
2. Hashed (password baru setelah diubah)

IMPLEMENTASI:
=============

SEBELUM:
--------
// Hanya support hashed password
if (!password_verify($passwordLama, $userData['password'])) {
    return error;
}

SESUDAH:
--------
// Support both plain text and hashed
$isPasswordValid = false;

// Check if password is hashed (bcrypt starts with $2y$)
if (strlen($userData['password']) == 60 && substr($userData['password'], 0, 4) == '$2y$') {
    // Password is hashed, use password_verify
    $isPasswordValid = password_verify($passwordLama, $userData['password']);
} else {
    // Password is plain text, compare directly
    $isPasswordValid = ($passwordLama === $userData['password']);
}

if (!$isPasswordValid) {
    return error;
}

// Update password with hash
$data['password'] = password_hash($passwordBaru, PASSWORD_DEFAULT);

CARA KERJA:
===========

1. Cek Format Password di Database:
   - Jika length = 60 dan starts with "$2y$" → HASHED
   - Jika tidak → PLAIN TEXT

2. Verify Password Lama:
   - HASHED: gunakan password_verify()
   - PLAIN TEXT: compare langsung (===)

3. Update Password Baru:
   - SELALU di-hash dengan password_hash()
   - Password baru akan tersimpan dalam format hashed

BENEFIT:
========

1. ✅ Support password lama yang plain text
2. ✅ Support password lama yang sudah di-hash
3. ✅ Password baru selalu di-hash (lebih aman)
4. ✅ Backward compatible dengan data lama
5. ✅ Forward compatible dengan data baru

SKENARIO:
=========

Skenario 1: Password Lama Plain Text
-------------------------------------
Database: tps123 (plain text)
Input: tps123
Verify: Direct comparison (tps123 === tps123) ✅
Update: password_hash('newpass123') → $2y$10$...
Result: Password berhasil diubah, sekarang di-hash

Skenario 2: Password Lama Sudah Di-Hash
----------------------------------------
Database: $2y$10$abc... (hashed)
Input: newpass123
Verify: password_verify('newpass123', '$2y$10$abc...') ✅
Update: password_hash('anotherpass') → $2y$10$xyz...
Result: Password berhasil diubah, tetap di-hash

KEAMANAN:
=========

1. Password Baru Selalu Di-Hash:
   - Menggunakan password_hash() dengan PASSWORD_DEFAULT
   - Algoritma: bcrypt
   - Cost: default (10)

2. Backward Compatible:
   - Tetap bisa login dengan password plain text lama
   - Setelah ubah password, otomatis jadi hashed

3. Migration Path:
   - User tidak perlu reset password
   - Saat user ubah password, otomatis migrate ke hashed
   - Bertahap semua password akan jadi hashed

FILE YANG DIMODIFIKASI:
=======================

1. ✅ app/Controllers/User/Profile.php
   - Method: changePassword()
   - Support plain text & hashed

2. ✅ app/Controllers/TPS/Profile.php
   - Method: changePassword()
   - Support plain text & hashed

TESTING:
========

Test dengan Password Plain Text:
---------------------------------
1. Login sebagai TPS (password: tps123 - plain text)
2. Akses /pengelola-tps/profile
3. Ubah Password:
   - Password Lama: tps123
   - Password Baru: newpass123
   - Konfirmasi: newpass123
4. Klik "Ubah Password"
5. Result: ✅ Berhasil
6. Logout dan login dengan password baru
7. Result: ✅ Bisa login

Test dengan Password Hashed:
-----------------------------
1. Login dengan password yang sudah di-hash
2. Ubah password
3. Result: ✅ Berhasil
4. Password baru tetap di-hash

REKOMENDASI:
============

Untuk keamanan lebih baik, hash semua password di database:

UPDATE users 
SET password = '$2y$10$...' 
WHERE LENGTH(password) < 60;

Atau buat script migration untuk hash semua password plain text.

STATUS: ✅ FIXED

Sekarang ubah password berfungsi dengan baik untuk:
- Password lama plain text ✅
- Password lama hashed ✅
- Password baru selalu di-hash ✅
